@page "/brands"
@using CarSaleSystem.Services
@using CarSaleSystem.Models
@inject CarSaleService CarService
@inject DialogService DialogService


<PageTitle>å“ç‰Œç®¡ç†</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1">ğŸ·ï¸ å“ç‰Œç®¡ç†</RadzenText>
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="add" Text="æ–°å¢å“ç‰Œ" Click="@OpenAddDialog" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenDataGrid @ref="brandsGrid" Data="@brands" TItem="Brand" AllowSorting="true" AllowFiltering="true" 
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowPaging="true" PageSize="10">
                    <Columns>
                        <RadzenDataGridColumn TItem="Brand" Property="BrandId" Title="å“ç‰Œç¼–å·" Width="120px" />
                        <RadzenDataGridColumn TItem="Brand" Property="BrandName" Title="å“ç‰Œåç§°" />
                        <RadzenDataGridColumn TItem="Brand" Property="Status" Title="çŠ¶æ€" Width="100px">
                            <Template Context="brand">
                                <RadzenBadge BadgeStyle="@(brand.Status == "1" ? BadgeStyle.Success : BadgeStyle.Danger)" 
                                             Text="@(brand.Status == "1" ? "æ­£å¸¸" : "å·²åˆ é™¤")" />
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Brand" Title="æ“ä½œ" Width="200px" Sortable="false" Filterable="false">
                            <Template Context="brand">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                                    <RadzenButton ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" Icon="edit" 
                                                  Click="@(() => OpenEditDialog(brand))" />
                                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Icon="delete" 
                                                  Click="@(() => DeleteBrand(brand.BrandId))" />
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    private RadzenDataGrid<Brand> brandsGrid;
    private IQueryable<Brand> brands;

    protected override async Task OnInitializedAsync()
    {
        await LoadBrands();
    }

    private async Task LoadBrands()
    {
        brands = await CarService.GetBrandsAsync();
    }

    private async Task OpenAddDialog()
    {
        var result = await DialogService.OpenAsync<BrandDialog>("æ–°å¢å“ç‰Œ", new Dictionary<string, object>
        {
            { "Brand", new Brand() }
        });

        if (result == true)
        {
            await LoadBrands();
            await brandsGrid.Reload();
        }
    }

    private async Task OpenEditDialog(Brand brand)
    {
        var result = await DialogService.OpenAsync<BrandDialog>("ç¼–è¾‘å“ç‰Œ", new Dictionary<string, object>
        {
            { "Brand", brand }
        });

        if (result == true)
        {
            await LoadBrands();
            await brandsGrid.Reload();
        }
    }

    private async Task DeleteBrand(int brandId)
    {
        var confirm = await DialogService.Confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå“ç‰Œå—ï¼Ÿ", "ç¡®è®¤åˆ é™¤", new ConfirmOptions
        {
            OkButtonText = "ç¡®å®š",
            CancelButtonText = "å–æ¶ˆ"
        });

        if (confirm == true)
        {
            await CarService.DeleteBrandAsync(brandId);
            await LoadBrands();
            await brandsGrid.Reload();
        }
    }
}