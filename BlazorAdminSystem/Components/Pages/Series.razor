@page "/series"
@using CarSaleSystem.Services
@using CarSaleSystem.Models
@inject CarSaleService CarService
@inject DialogService DialogService

<PageTitle>è½¦ç³»ç®¡ç†</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1">ğŸ“š è½¦ç³»ç®¡ç†</RadzenText>
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="add" Text="æ–°å¢è½¦ç³»" Click="@OpenAddDialog" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenDataGrid @ref="seriesGrid" Data="@series" TItem="CarSaleSystem.Models.Series" AllowSorting="true" AllowFiltering="true" 
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowPaging="true" PageSize="10">
                    <Columns>
                        <RadzenDataGridColumn TItem="CarSaleSystem.Models.Series" Property="SeriesId" Title="è½¦ç³»ç¼–å·" Width="120px" />
                        <RadzenDataGridColumn TItem="CarSaleSystem.Models.Series" Property="SeriesName" Title="è½¦ç³»åç§°" />
                        <RadzenDataGridColumn TItem="CarSaleSystem.Models.Series" Property="Brand.BrandName" Title="æ‰€å±å“ç‰Œ" />
                        <RadzenDataGridColumn TItem="CarSaleSystem.Models.Series" Property="Status" Title="çŠ¶æ€" Width="100px" TextAlign="TextAlign.Center">
                            <Template Context="s">
                                <RadzenBadge BadgeStyle="@(s.Status == "1" ? BadgeStyle.Success : BadgeStyle.Danger)" 
                                             Text="@(s.Status == "1" ? "æ­£å¸¸" : "å·²åˆ é™¤")" />
                                             
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="CarSaleSystem.Models.Series" Title="æ“ä½œ" Width="200px" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                            <Template Context="s">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.Center">
                                    <RadzenButton ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" Icon="edit" 
                                                  Click="@(() => OpenEditDialog(s))" />
                                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Icon="delete" 
                                                  Click="@(() => DeleteSeries(s.SeriesId))" />
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    private RadzenDataGrid<CarSaleSystem.Models.Series> seriesGrid = default!;
    private IQueryable<CarSaleSystem.Models.Series>? series;

    protected override async Task OnInitializedAsync()
    {
        await LoadSeries();
    }

    private async Task LoadSeries()
    {
        series = await CarService.GetSeriesAsync();
    }

    private async Task OpenAddDialog()
    {
        var result = await DialogService.OpenAsync<SeriesDialog>("æ–°å¢è½¦ç³»", new Dictionary<string, object>
        {
            { "Series", new CarSaleSystem.Models.Series() }
        });

        if (result == true)
        {
            await LoadSeries();
            await seriesGrid.Reload();
        }
    }

    private async Task OpenEditDialog(CarSaleSystem.Models.Series s)
    {
        var seriesToEdit = new CarSaleSystem.Models.Series
        {
            SeriesId = s.SeriesId,
            BrandId = s.BrandId,
            SeriesName = s.SeriesName,
            Status = s.Status
        };
        
        var result = await DialogService.OpenAsync<SeriesDialog>("ç¼–è¾‘è½¦ç³»", new Dictionary<string, object>
        {
            { "Series", seriesToEdit }
        });

        if (result == true)
        {
            await LoadSeries();
            await seriesGrid.Reload();
        }
    }

    private async Task DeleteSeries(int seriesId)
    {
        var confirm = await DialogService.Confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè½¦ç³»å—ï¼Ÿ", "ç¡®è®¤åˆ é™¤", new ConfirmOptions
        {
            OkButtonText = "ç¡®å®š",
            CancelButtonText = "å–æ¶ˆ"
        });

        if (confirm == true)
        {
            await CarService.DeleteSeriesAsync(seriesId);
            await LoadSeries();
            await seriesGrid.Reload();
        }
    }
}