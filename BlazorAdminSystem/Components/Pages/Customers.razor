@page "/customers"
@using CarSaleSystem.Services
@using CarSaleSystem.Models
@inject CarSaleService CarService
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>å®¢æˆ·ç®¡ç†</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1">ğŸ‘¥ å®¢æˆ·ç®¡ç†</RadzenText>
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="add" Text="æ–°å¢å®¢æˆ·" Click="@OpenAddDialog" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenDataGrid @ref="customersGrid" Data="@customers" TItem="Customer" AllowSorting="true" AllowFiltering="true" 
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowPaging="true" PageSize="10">
                    <Columns>
                        <RadzenDataGridColumn TItem="Customer" Property="Id" Title="ç¼–å·" Width="80px" />
                        <RadzenDataGridColumn TItem="Customer" Property="Name" Title="å§“å" Width="150px" />
                        <RadzenDataGridColumn TItem="Customer" Property="Phone" Title="ç”µè¯" Width="150px" />
                        <RadzenDataGridColumn TItem="Customer" Property="IdCard" Title="èº«ä»½è¯å·" Width="200px" />
                        <RadzenDataGridColumn TItem="Customer" Property="CreateTime" Title="æ³¨å†Œæ—¶é—´" FormatString="{0:yyyy-MM-dd HH:mm}" />
                        <RadzenDataGridColumn TItem="Customer" Title="æ“ä½œ" Width="150px" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                            <Template Context="customer">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.Center">
                                    <RadzenButton ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" Icon="edit" 
                                                  Click="@(() => OpenEditDialog(customer))" />
                                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Icon="delete" 
                                                  Click="@(() => DeleteCustomer(customer.Id))" />
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    private RadzenDataGrid<Customer> customersGrid;
    private IQueryable<Customer> customers;

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
    }

    private async Task LoadCustomers()
    {
        customers = await CarService.GetCustomersAsync();
    }

    private async Task OpenAddDialog()
    {
        var result = await DialogService.OpenAsync<CustomerDialog>("æ–°å¢å®¢æˆ·", new Dictionary<string, object>
        {
            { "Customer", new Customer() }
        });

        if (result is Customer newCustomer)
        {
            try
            {
                await CarService.CreateCustomerAsync(newCustomer);
                await LoadCustomers();
                await customersGrid.Reload();
            }
            catch(Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "é”™è¯¯", "åˆ›å»ºå®¢æˆ·å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç”µè¯æˆ–èº«ä»½è¯å·é‡å¤ã€‚");
            }
        }
    }

    private async Task OpenEditDialog(Customer customer)
    {
        var customerToEdit = new Customer // Create a copy for editing
        {
            Id = customer.Id,
            Name = customer.Name,
            Phone = customer.Phone,
            IdCard = customer.IdCard,
            CreateTime = customer.CreateTime
        };
        
        var result = await DialogService.OpenAsync<CustomerDialog>("ç¼–è¾‘å®¢æˆ·", new Dictionary<string, object>
        {
            { "Customer", customerToEdit }
        });

        if (result is Customer updatedCustomer)
        {
            try
            {
                await CarService.UpdateCustomerAsync(updatedCustomer);
                await LoadCustomers();
                await customersGrid.Reload();
            }
            catch(Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "é”™è¯¯", "æ›´æ–°å®¢æˆ·å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç”µè¯æˆ–èº«ä»½è¯å·é‡å¤ã€‚");
            }
        }
    }

    private async Task DeleteCustomer(long customerId)
    {
        var confirm = await DialogService.Confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®¢æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚", "ç¡®è®¤åˆ é™¤", new ConfirmOptions
        {
            OkButtonText = "ç¡®å®š",
            CancelButtonText = "å–æ¶ˆ"
        });

        if (confirm == true)
        {
            await CarService.DeleteCustomerAsync(customerId);
            await LoadCustomers();
            await customersGrid.Reload();
        }
    }
}